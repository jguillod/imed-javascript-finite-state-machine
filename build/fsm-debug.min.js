var DEBUG=!0;
/**
 * @license
 * The MIT License (MIT)
 *
 * Copyright (c) Joel F Guillod <joel.guillod@gmail.com> (www.imed.ch)
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */
/**
 * @license
 * The MIT License (MIT)
 *
 * Copyright (c) Joel F Guillod <joel.guillod@gmail.com> (www.imed.ch)
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */
!function(t){"use strict";if("function"==typeof bootstrap)bootstrap("jsfsm",t);else if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define(t);else if("undefined"!=typeof ses){if(!ses.ok())return;ses.makeQ=t}else{if("undefined"==typeof self)throw"This environment was not anticipated by imed-javascript-finite-state-machine. Please file a bug.";self.FSM=t()}}(function(){"use strict";function t(e,t){var n,r,o=this,i=this._transitions={},s=this._states={},a=this._fromStates={},c=e._,f=this._private=Object.assign({initial:"none"},c);this.debug=!!f.debug,f.justListen=!1!==f.justListen,this._listeners=[],this.e={},this.original=function(){return o},Object.freeze(this.original),Object.getOwnPropertyNames(e).forEach(function(t){n=e[t],"_"!=t&&(n.entry||n.exit||n.actions?(!(s[t]=n).exit||n.exit instanceof Array||(n.exit=[n.exit]),!n.entry||n.entry instanceof Array||(n.entry=[n.entry]),n.hasOwnProperty("actions")||(n.actions={})):(i[t]=n instanceof Array?n:[n],this.e[t]||(this.e[t]=l(this,t))))},this),Object.getOwnPropertyNames(i).forEach(function(e){i[e].forEach(function(t){!t.before||t.before instanceof Array||(t.before=[t.before]),!t.after||t.after instanceof Array||(t.after=[t.after]),!t.do||t.do instanceof Array||(t.do=[t.do]),!t.guard||t.guard instanceof Array||(t.guard=[t.guard]),!t.dont||t.dont instanceof Array||(t.dont=[t.dont]),t.from&&!s[t.from]&&(s[t.from]={}),t.to&&!s[t.to]&&(s[t.to]={}),r=t.from||"none",a[r]||(a[r]={}),a[r][e]=t,Object.freeze(t),Object.freeze(a[r][e]),Object.freeze(s[t.from]),Object.freeze(s[t.to])})},this),Object.freeze(i),Object.freeze(s),Object.freeze(a),Object.freeze(f),Object.freeze(this.e),this._pendingTransition=!1,this._lockKey=null,this._lifeCycle=[],y(this,f.initial),this.logger("‚ìÇÔ∏è MACHINE INSTANCIATED",this),"function"==typeof t&&t.call(this,this)}function l(o,i){return function(t){for(var e=0,n=arguments.length,r=new Array(n);e<n;++e)r[e]=arguments[e];return o.trigger.apply(o,[i].concat(r))}}function y(t,e,n){if(t._addHistory(e,n),t._current=e,!t._states.hasOwnProperty(e))throw'unknown state "'+e+"'";t._actions=Object.assign({},t._states[e].actions)}function s(e,t,n,r){var o=n.guard;e.logger("‚ùì GUARD in availEvents | event ‚Äú%s‚Äù | transition",t,n);var i={step:"guard",event:t,from:n.from,to:n.to,options:n.options};return!o||o.every(function(t){return!t||t.apply(e,[i].concat(r))})}return Object.defineProperty(t.prototype,"actions",{get:function(){return this._actions}}),t.prototype.factory=function(t,e){var n=this,r=Object.getOwnPropertyNames(n.e),o=n._private.initial;function i(t,e){1===arguments.length&&"function"==typeof t&&(cb=t,t=null),this._debug=!1,this._pendingTransition=!1,this._listeners=[],this._lockKey=null,this._lifeCycle=[],this._initial="",this.reason=null,y(this,t||o),this.e={},r.forEach(function(t){this.e[t]=l(this,t)},this),Object.freeze(this.e),"function"==typeof e&&e.call(this,this)}return i.prototype=n,new i(t,e)},t.prototype.resetMachine=function(t){if(this.isLocked()&&!this.testLock(t))throw"Reseting machine is forbidden by a lock";if(this._pendingTransition)throw"Reseting machine is forbidden during a transition";y(this,this._private.initial)},t.prototype.engineVersion=function(){return"JFG's FSM engine v 0.8.1 Tue Feb 16 2016 13:02:36 GMT+0100 (CET)"},t.prototype.version=function(){return this._private.version||"unknown"},t.prototype.lock=function(){if(this.isLocked())throw"Machine is already locked";return this._lockKey=arguments[0]||{}},t.prototype.unlock=function(t){return this._lockKey&&t===this._lockKey&&(this._lockKey=null),null===this._lockKey},t.prototype.testLock=function(t){return t===this._lockKey},t.prototype.isLocked=function(){return null!==this._lockKey},t.prototype.status=function(){var t={engine:this.engineVersion(),version:this.version(),state:this._current,pending:this._pendingTransition};return this._private.namespace&&(t.namespace=this._private.namespace),t},t.prototype.current=function(){return this._current},t.prototype._addHistory=function(t,e){var n={date:new Date,to:t};this._current&&(n.from=this._current),e&&(n.event=e),Object.freeze(n),this._lifeCycle.push(n)},t.prototype.history=function(){return this._lifeCycle.concat()},t.prototype.on=function(t,e,n){var r=3,o=n;"function"==typeof e&&(o=e,e=this,r=2);for(var i=arguments.length,s=[];r<i;++r)s.push(arguments[r]);return function(t,e,n,r,o){var i={fn:r,scope:n};return 0<o.length&&(i.options=o,t.logger('Add a listener for "%s" with options',e,o,arguments)),t._listeners.length+1===t._listeners.push({pattern:e,observer:i})}(this,t,e,o,s)},t.prototype.un=function(t,e,n){var r=n;return"function"==typeof e&&(r=e,e=this),function(t,r,o,i){var e=t._listeners.length;return t._listeners=t._listeners.filter(function(t){var e=t.observer.fn,n=t.observer.scope;return t.pattern!=r.toString()||o!==n||i!==e}),e>t._listeners.length}(this,t,e,r)},t.prototype.availActions=function(){return Object.getOwnPropertyNames(this.actions)},t.prototype.availEvents=function(e){for(var n=this._fromStates[this._current],r=this,t=1,o=arguments.length,i=t<o?new Array(o-t):[];t<o;++t)i[t-1]=arguments[t];return Object.getOwnPropertyNames(n).filter(function(t){return!0!==e||s(r,t,n[t],i)})},t.prototype.can=function(t,e){if(0===arguments.length)return!1;for(var n=2,r=arguments.length,o=n<r?new Array(r-n):[];n<r;++n)o[n-2]=arguments[n];return!0===e?s(this,t,this._fromStates[this._current][t],o):this._fromStates[this._current].hasOwnProperty(t)},t.prototype.is=function(t){return this._current===t},t.prototype._fsmListeners=function(t,f){var e,l=this,u=this._private.justListen,n=t.event,r=t.to,o=t.from,i=t.state,p=t.step+(i?"-"+i:(n?"-"+n:"")+(o?"-"+o:"")+(r?"-"+r:"")),s=l._listeners,g=Object.assign({},t);l.loggroup("‚ùì _fsmListeners "+p+" ("+s.length+" possible listeners)"),l.logger("with arguments template",g,f);try{e=s.every(function(t){var e,n=t.pattern,r=t.observer,o=r.fn,i=r.scope,s=r.options,a=Object.freeze(Object.assign(s?{options:s}:{},g)),c=!0;return(n instanceof RegExp?n.test(p):n===p)&&(e=[a].concat(f),l.logger("üí• %cExecuting listener : %s with arguments","color:red;font-style:italic",o.toString(),e),c=o.apply(i,e)),c||u})}finally{l.logger('_fsmListeners "%s" returns : %c%s',p,e,"color:"+(e?"green":"red")+";font-weight:bold"),l.loggroup()}return e},t.prototype.recoverPendingTransition=function(){this._pendingTransition=!1},t.prototype.isInTransition=function(){return this._pendingTransition},t.prototype.t=t.prototype.trigger=function(t){var e=1;if(this.isLocked()){if(!this.testLock(arguments[1]))return!(this.reason="Trigger is forbidden by a lock");e=2}if(this._pendingTransition)return this.reason="Cannot trigger '"+arguments[e]+"' : previous transition is not completed",!1;this._pendingTransition=!0;for(var n=arguments.length,r=[];e<n;++e)r.push(arguments[e]);var o=function(s,t,a){var e=s._current,n=s._fromStates[e][t],r=!0,c=s._private.justListen;if(a=a||[],s.reason=null,!n)return s.reason="Cannot trigger '"+t+"' : undefined transition in current state '"+e+"'",!1;var o=n.to,f=n.options,i={event:t,from:e},l={state:e},u={state:o};o&&(i.to=o);function p(e,t,n){s.loggroup('‚ùì‚ùì Listeners "'+e+'"'),s.loggroup("‚ùì in configs ("+(n?n.length:0)+" functions)"),t.step=e;var r,o,i={};f&&(i.options=f);try{i=Object.freeze(Object.assign(i,t)),o=[i].concat(a),r=!n||n.every(function(t){return s.logger("üí• %cExecuting FSM %s : %s with arguments","color:red;font-style:italic",e,t.toString(),o),!t||t.apply(s,o)})}finally{s.loggroup(),c?s._fsmListeners(t,a):r=r&&s._fsmListeners(t,a),s.loggroup(),s.logger('Listeners "%s" returns : %c%s',e,"color:"+(r?"green":"red")+";font-weight:bold",r)}return r}function g(){return p("dont",i,n.dont)}{var h="Transition "+t;s.loggroup('‚ö° TRIGGER TRANSITION "'+t+'" : from "'+e+'" to "'+o+'"'),s.logger("TRANSITION",n),s.logger("ARGUMENTS",a),s.logTime(h)}try{if(!0!==p("before",i,n.before))throw"before cancelled the transition";if(!0!==p("guard",i,n.guard))throw g(),"guard cancelled the transition";if(o){if(!0!==p("exit",l,s._states[e].exit))throw g(),"exit cancelled the transition";s._actions={}}p("do",i,n.do),o&&(y(s,o,t),p("entry",u,s._states[o].entry))}catch(t){s.logerror(t),s.reason=t,r=!1}finally{try{p("after",i,n.after)}catch(t){s.logerror(t),s.reason={error:t,step:"after"},r=!1}s.loggroup(),s.logTimeEnd(h),s.logger("üîµ The transition returns => %c%s (reason : %o)","color:"+(r?"green":"red")+";font-weight:bold",r,s.reason),s.logger('üîµ Current state is "%c%s%c". Available events : "%s".',"color:blue;font-weight:bold",s._current,"",s.availEvents().join('","'))}return r}(this,t,r);return this._pendingTransition=!1,o},Object.defineProperty(t.prototype,"debug",{set:function(t){this._debug=!!this.logger&&!!(t&&console&&console.log&&console.time&&console.timeEnd)},get:function(){return this._debug}}),t.prototype.logger=function(){if(this._debug){for(var t=0,e=arguments.length,n=new Array(e);t<e;++t)n[t]=arguments[t];console.log.apply(console,n)}},t.prototype.logerror=function(){if(this._debug){for(var t=0,e=arguments.length,n=new Array(e);t<e;++t)n[t]=arguments[t];console[console.error?"error":"log"].apply(console,n),console.trace()}},t.prototype.loggroup=function(){if(this._debug)if(arguments.length){for(var t=0,e=arguments.length,n=new Array(e);t<e;++t)n[t]=arguments[t];console.groupCollapsed?console.groupCollapsed.apply(console,n):console.group&&console.group.apply(console,n)}else console.groupEnd&&console.groupEnd()},t.prototype.logTime=function(t){this._debug&&console.time(t)},t.prototype.logTimeEnd=function(t){this._debug&&console.timeEnd(t)},t});